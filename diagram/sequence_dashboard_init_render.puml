@startuml
skinparam sequenceMessageAlign center
skinparam maxMessageSize 250
autonumber

participant Backend
participant MosaicProvider
participant MosaicContext
participant DashboardGrid
participant WidgetFactory
participant WidgetComponent
participant useMosaicStore
participant StoreManager
participant RobotConnectorRefMap
participant StoreFactory
participant MosaicStore
participant ChannelManager

== WS 연결 & RobotInfo 업데이트 ==

MosaicProvider -[#black]> MosaicProvider: WS 연결됨

MosaicProvider -[#red]> Backend: "get_robot_list" 메시지
note right of Backend: WebSocket 메시지

Backend --[#blue]> MosaicProvider: 로봇 리스트 with RobotConfig
note right of Backend: "robot_config_example.json 참고"

MosaicProvider -[#red]> MosaicContext: updateRobotInfo(robotInfo)
MosaicContext --[#blue]> MosaicProvider: 완료

note right of DashboardGrid: 이후 로봇 상태 변경 시\n서버가 자동으로 메시지 전송

== 대시보드 컴포넌트 렌더링 ==
MosaicProvider -> DashboardGrid: Child 컴포넌트 마운트
activate DashboardGrid

DashboardGrid -[#red]> Backend: 탭 리스트 조회
note right of Backend: API: GET /api/v1/dashboard/tabs

Backend --[#blue]> DashboardGrid: 탭 리스트
note right of Backend
[
    {
        "id": "524dee3a-fb2c-45ff-bbe5-93ec036ae3ea",
        "name": "For outdoor"
    }
]
end note

DashboardGrid -[#black]> DashboardGrid: 현재 탭 LocalStorage에서 로드

DashboardGrid -[#red]> Backend: 대시보드 설정 조회
note right of Backend: API: GET /api/v1/dashboard/{tabId}/configs

Backend --[#blue]> DashboardGrid: DashboardConfig
note right of Backend: "dashboard_config_example.json 참고"

DashboardGrid -[#red]> WidgetFactory: renderWidget(widgetConfig)

WidgetFactory -[#red]> WidgetComponent: WidgetComponent 렌더링
activate WidgetComponent

WidgetComponent -[#red]> useMosaicStore: getOrCreateStore(robotConnector)

useMosaicStore -[#red]> StoreManager: getOrCreateStore(robotConnector, robotConfig)
activate StoreManager

StoreManager -[#black]> StoreManager: resolveConnectorType(robotConnector)

StoreManager -[#red]> RobotConnectorRefMap: get(robotConnector)
RobotConnectorRefMap --[#blue]> StoreManager: MosaicStore | undefined

alt store가 없을 때
  StoreManager -[#red]> StoreFactory: createStore(connectorType, robotConnector)
  activate StoreFactory
  
  StoreFactory -[#black]> StoreFactory: storeFactories.get(connectorType)
  
  StoreFactory -[#red]> MosaicStore: createStore(connectorType, robotConnector)
  MosaicStore --[#blue]> StoreFactory: MosaicStore | null

  StoreFactory --[#blue]> StoreManager: MosaicStore | null
  deactivate StoreFactory
  
  StoreManager -[#red]> RobotConnectorRefMap: set(robotConnector, MosaicStore)
  RobotConnectorRefMap --[#blue]> StoreManager: 완료
end

StoreManager -[#red]> RobotConnectorRefMap: incrementRefCount(robotConnector)
RobotConnectorRefMap --[#blue]> StoreManager: 완료

StoreManager --[#blue]> useMosaicStore: MosaicStore
useMosaicStore --[#blue]> WidgetComponent: MosaicStore
deactivate StoreManager

WidgetComponent -[#black]> WidgetComponent: create ChannelRequirement

WidgetComponent -[#red]> ChannelManager: addChannelRequirement(channelRequirement)
activate ChannelManager

ChannelManager -[#black]> ChannelManager: 내부 channelRequirements에 저장\n(key = robotId)

ChannelManager --[#blue]> WidgetComponent: 완료
deactivate ChannelManager

alt ReceivableStore일 때
  WidgetComponent -[#red]> MosaicStore: subscribe(subscriber: (data: ArrayBuffer) => void)
  MosaicStore --[#blue]> WidgetComponent: UnsubscribeFunction
end

WidgetComponent --[#blue]> WidgetFactory: 렌더링 완료
deactivate WidgetComponent

WidgetFactory --[#blue]> DashboardGrid: 위젯 렌더링 완료
deactivate WidgetFactory

deactivate DashboardGrid
@enduml