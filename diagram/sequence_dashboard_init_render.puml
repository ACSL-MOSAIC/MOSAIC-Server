@startuml
skinparam sequenceMessageAlign center
skinparam maxMessageSize 250
autonumber

participant "Backend" as Backend
participant "DashboardGrid" as DashboardGrid
participant "MosaicContext" as MosaicContext
participant "WidgetFactory" as WidgetFactory
participant "WidgetComponent" as WidgetComponent
participant "useMosaicStore" as useMosaicStore
participant "StoreManager" as StoreManager
participant "RobotConnectorRefMap" as RobotConnectorRefMap
participant "StoreFactory" as StoreFactory
participant "MosaicStore" as MosaicStore
participant "ReadableStore" as ReadableStore
participant "ChannelManager" as ChannelManager

DashboardGrid -[#black]> DashboardGrid: 컴포넌트 마운트
activate DashboardGrid

DashboardGrid -[#red]> Backend: 로봇 리스트 조회
activate Backend
note right of Backend: API: GET /api/robots (미정)

Backend --[#blue]> DashboardGrid: 로봇 리스트 with RobotConfig
deactivate Backend

DashboardGrid -[#red]> MosaicContext: updateRobotInfo(robotInfo)
activate MosaicContext

MosaicContext --[#blue]> DashboardGrid: 완료
deactivate MosaicContext

DashboardGrid -[#red]> Backend: 탭 리스트 조회
activate Backend
note right of Backend: API: GET /api/dashboard/tabs (미정)

Backend --[#blue]> DashboardGrid: 탭 리스트
deactivate Backend

DashboardGrid -[#black]> DashboardGrid: 현재 탭 LocalStorage에서 로드

DashboardGrid -[#red]> Backend: 대시보드 설정 조회
activate Backend
note right of Backend: API: GET /api/dashboard/configs (미정)

Backend --[#blue]> DashboardGrid: DashboardConfig
deactivate Backend

DashboardGrid -[#black]> DashboardGrid: 마운트 완료

DashboardGrid -[#red]> WidgetFactory: renderWidget(widgetConfig)
activate WidgetFactory

WidgetFactory -[#red]> WidgetComponent: WidgetComponent 렌더링
activate WidgetComponent

WidgetComponent -[#red]> useMosaicStore: getOrCreateStore(robotConnector)
activate useMosaicStore

useMosaicStore -[#red]> StoreManager: getOrCreateStore(robotConnector, robotConfig)
activate StoreManager

StoreManager -[#black]> StoreManager: resolveConnectorType(robotConnector)

StoreManager -[#red]> RobotConnectorRefMap: get(robotConnector)
activate RobotConnectorRefMap

RobotConnectorRefMap --[#blue]> StoreManager: MosaicStore | undefined
deactivate RobotConnectorRefMap

alt store가 없을 때
  StoreManager -[#red]> StoreFactory: createStore(connectorType, robotConnector)
  activate StoreFactory
  
  StoreFactory -[#black]> StoreFactory: storeFactories.get(connectorType)
  
  StoreFactory -[#red]> MosaicStore: createStore(connectorType, robotConnector)
  activate MosaicStore
  MosaicStore --[#blue]> StoreFactory: MosaicStore | null
  deactivate MosaicStore
  
  StoreFactory --[#blue]> StoreManager: MosaicStore | null
  deactivate StoreFactory
  
  StoreManager -[#red]> RobotConnectorRefMap: set(robotConnector, 1)
  activate RobotConnectorRefMap
  RobotConnectorRefMap --[#blue]> StoreManager: 완료
  deactivate RobotConnectorRefMap
end

StoreManager -[#red]> RobotConnectorRefMap: incrementRefCount(robotConnector)
activate RobotConnectorRefMap

RobotConnectorRefMap --[#blue]> StoreManager: 완료
deactivate RobotConnectorRefMap

StoreManager --[#blue]> WidgetComponent: MosaicStore
deactivate StoreManager
deactivate useMosaicStore

WidgetComponent -[#black]> WidgetComponent: create ChannelRequirement

WidgetComponent -[#red]> ChannelManager: addChannelRequirement(channelRequirement)
activate ChannelManager

ChannelManager -[#black]> ChannelManager: 내부 channelRequirements에 저장\n(key = robotId)

ChannelManager --[#blue]> WidgetComponent: 완료
deactivate ChannelManager

alt ReadableStore일 때
  WidgetComponent -[#red]> MosaicStore: subscribe(subscriber: (data: ArrayBuffer) => void)
  activate MosaicStore
  
  MosaicStore --[#blue]> WidgetComponent: UnsubscribeFunction
  deactivate MosaicStore
end

WidgetComponent --[#blue]> WidgetFactory: 렌더링 완료
deactivate WidgetComponent

WidgetFactory --[#blue]> DashboardGrid: 위젯 렌더링 완료
deactivate WidgetFactory

deactivate DashboardGrid

@enduml