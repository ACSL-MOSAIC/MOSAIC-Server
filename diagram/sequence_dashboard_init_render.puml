@startuml
'https://plantuml.com/sequence-diagram

participant DashboardGrid
participant Backend
participant WebSocketContext
participant WidgetFactory
participant WidgetComponent
participant StoreManager
participant RobotConnectorRefMap
participant StoreFactory
participant MosaicStore
participant ChannelManager

autonumber

== 대시보드 페이지 접속 ==

DashboardGrid -> DashboardGrid: 컴포넌트 마운트

== 로봇 리스트 렌더링을 위한 API 호출 ==

DashboardGrid -[#red]> Backend: 로봇 리스트 조회
note right
  API: GET /api/robots <----미정
end note
DashboardGrid <[#blue]- Backend: 로봇 리스트 with RobotConfig
note right
  class diagram 참고
end note
DashboardGrid -[#red]> WebSocketContext: setRobotConfigs(robotConfigs)
note over DashboardGrid, WebSocketContext
  WebSocketContext는 로봇 정보를 관리하는 Context,
  RobotConfig도 함께 저장하여 통합 관리
end note
DashboardGrid <[#blue]- WebSocketContext: 완료

== 대시보드 렌더링을 위한 API 호출 ==

DashboardGrid -[#red]> Backend: 탭 리스트 조회
note right
  API: GET /api/dashboard/tabs <----미정
end note
DashboardGrid <[#blue]- Backend: 탭 리스트

DashboardGrid -> DashboardGrid: 현재 탭 LocalStorage에서 로드

DashboardGrid -[#red]> Backend: 대시보드 설정 조회
note right
  API: GET /api/dashboard/configs <----미정
end note
DashboardGrid <[#blue]- Backend: DashboardConfig
note right
  class diagram 참고
end note

DashboardGrid -> DashboardGrid --: 마운트 완료

== 위젯 렌더링 ==

DashboardGrid -[#red]> WidgetFactory: renderWidget(widgetConfig)
WidgetFactory -[#red]> WidgetComponent ++: WidgetComponent 렌더링
note right
아래 로직이 useEffect 에서 이루어질지는 잘 모르겠음. (useEffect 에서 안이루어질수도)
end note

WidgetComponent -[#red]> StoreManager ++: getOrCreateStore(robotConnector)
StoreManager -> StoreManager: resolveConnectorType(robotConnector)
StoreManager -[#red]> WebSocketContext: getRobotConfig(robotId)
note over StoreManager, WebSocketContext
  resolveConnectorType 내부에서
  WebSocketContext를 참조하여
  RobotConfig를 가져와
  connectorType 결정
end note
WebSocketContext -[#blue]> StoreManager: RobotConfig | undefined
StoreManager -> StoreManager: connectorType 결정

StoreManager -[#red]> RobotConnectorRefMap: get(robotConnector)
RobotConnectorRefMap -[#blue]> StoreManager: MosaicStore | undefined

alt Store가 없을 때
    StoreManager -[#red]> StoreFactory ++: createStore(connectorType, robotConnector)
    StoreFactory -> StoreFactory: storeFactories.get(connectorType)
    create MosaicStore
    StoreFactory -> MosaicStore: create(robotConnector)
    StoreManager <[#blue]- StoreFactory --: MosaicStore | null

    StoreManager -[#red]> RobotConnectorRefMap: set(robotConnector, MosaicStore)
end

WidgetComponent <[#blue]- StoreManager --: MosaicStore

WidgetComponent -> WidgetComponent: create ChannelRequirement

WidgetComponent -[#red]> ChannelManager: addChannelRequirement(channelRequirement)
ChannelManager -> ChannelManager: 내부 channelRequirements 에 저장
WidgetComponent <[#blue]- ChannelManager

alt ReadableStore 일 때
    WidgetComponent -[#red]> MosaicStore: subscribe(subscriber: (data: ArrayBuffer) => void)
    WidgetComponent <[#blue]- MosaicStore: UnsubscribeFunction
    note over WidgetComponent, MosaicStore
      위젯 컴포넌트가 언마운트 될 때 또는 구독이 필요하지 않을 때
      UnsubscribeFunction 호출하여 구독 해제
    end note
end

WidgetFactory <[#blue]- WidgetComponent --: 렌더링 완료
DashboardGrid <[#blue]- WidgetFactory: 위젯 렌더링 완료
@enduml