@startuml
skinparam sequenceMessageAlign center
skinparam maxMessageSize 250
autonumber

participant "DashboardGrid" as DashboardGrid
participant "MosaicContext" as MosaicContext
participant "RobotInfo" as RobotInfo
participant "WebRTCConnection" as WebRTCConnection

== 로봇 연결 시작 ==

DashboardGrid -[#red]> MosaicContext: requestConnection(robotId)
activate MosaicContext

== WebSocket 연결 ==

MosaicContext -[#black]> MosaicContext: wsObjects.set(robotId, ws)

MosaicContext -[#red]> RobotInfo: setWSConnection(true)
activate RobotInfo
RobotInfo -[#black]> RobotInfo: this.wsConnected = true
RobotInfo --[#blue]> MosaicContext: 완료
deactivate RobotInfo

== WebRTC Connection 생성 ==

MosaicContext -[#red]> WebRTCConnection: startConnection()
activate WebRTCConnection

WebRTCConnection -[#black]> WebRTCConnection: createPeerConnection()



WebRTCConnection -[#black]> WebRTCConnection: ondatachannel 이벤트 발생
note right of WebRTCConnection: 로봇으로부터 DataChannel 수신

loop 각 DataChannel
  WebRTCConnection -[#black]> WebRTCConnection: setupDataChannel(dataChannel, robotId)
end

WebRTCConnection -[#blue]> MosaicContext: connections.set(robotId, this)

deactivate WebRTCConnection

== Channel 등록 ==

MosaicContext -[#black]> MosaicContext: ChannelRequirements 참조

loop 각 ChannelRequirement
  MosaicContext -[#black]> MosaicContext: registerActiveChannel(channelInfo)

  MosaicContext -[#black]> MosaicContext: onCallbackRegistered(robotConnector, callback)
  note right of MosaicContext: Store 콜백과\nDataChannel 연결
end

== 연결 완료 ==

MosaicContext -[#red]> RobotInfo: setRTCStatus("CONNECTED")
activate RobotInfo
RobotInfo -[#black]> RobotInfo: this.rtcStates = "CONNECTED"
RobotInfo --[#blue]> MosaicContext: 완료
deactivate RobotInfo

MosaicContext --[#blue]> DashboardGrid: 연결 완료
deactivate MosaicContext

DashboardGrid -[#black]> DashboardGrid: UI 업데이트 (연결됨 표시)

deactivate DashboardGrid

@enduml