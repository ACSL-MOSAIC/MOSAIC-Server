@startuml
skinparam sequenceMessageAlign center
skinparam maxMessageSize 250
autonumber

participant "Backend" as Backend
participant "DashboardGrid" as DashboardGrid
participant "WidgetFactory" as WidgetFactory
participant "WidgetComponent" as WidgetComponent
participant "MosaicContext" as MosaicContext
participant "MosaicStore" as MosaicStore

== 위젯 추가 ==


DashboardGrid -[#black]> DashboardGrid: handleAddWidget(type, robotId, config)
activate DashboardGrid

note right of DashboardGrid: 새로운 WidgetConfig 생성

DashboardGrid -[#red]> WidgetFactory: renderWidget(widgetConfig)
activate WidgetFactory

WidgetFactory -[#black]> WidgetFactory: WidgetComponent 타입 선택\n(widgetConfig.type 기반)

WidgetFactory -[#red]> WidgetComponent: new WidgetComponent(widgetConfig)
activate WidgetComponent

note right of WidgetComponent: 위젯 컴포넌트 마운트 시작

== Store 생성/조회 & 구독 ==

WidgetComponent -[#red]> MosaicContext: getOrCreateStore(robotConnector)
activate MosaicContext

MosaicContext --[#blue]> WidgetComponent: MosaicStore
deactivate MosaicContext

alt MosaicStore가 MosaicStore 경우
  WidgetComponent -[#red]> MosaicStore: subscribe(subscriber)
  activate MosaicStore
  
  MosaicStore -[#black]> MosaicStore: subscriberList에 추가
  
  MosaicStore --[#blue]> WidgetComponent: unsubscribe function
  deactivate MosaicStore
end

== Channel Requirement 등록 ==

WidgetComponent -[#black]> WidgetComponent: create ChannelRequirement

WidgetComponent -[#red]> MosaicContext: addChannelRequirement(channelRequirement)
activate MosaicContext

note right of MosaicContext: ChannelManager에\nchannelRequirement 저장

MosaicContext --[#blue]> WidgetComponent: 완료
deactivate MosaicContext

== 데이터 콜백 등록 ==

WidgetComponent -[#red]> MosaicContext: registerDataCallback(robotConnector, callback)
activate MosaicContext

note right of MosaicContext: ChannelManager에\n콜백 등록


MosaicContext --[#blue]> WidgetComponent: 완료
deactivate MosaicContext

== 위젯 렌더링 완료 ==

WidgetComponent -[#black]> WidgetComponent: render()
note right of WidgetComponent: 초기 상태로 렌더링

WidgetComponent --[#blue]> WidgetFactory: ReactElement
deactivate WidgetComponent

WidgetFactory --[#blue]> DashboardGrid: 위젯 추가 완료
deactivate WidgetFactory

DashboardGrid -[#black]> DashboardGrid: 화면에 위젯 표시
DashboardGrid -[#red]> Backend : WidgetConfig 업데이트
note left of DashboardGrid : POST /api/dashboard/configs <-- 미정

Backend -[#blue]> DashboardGrid : 완료

deactivate DashboardGrid

@enduml